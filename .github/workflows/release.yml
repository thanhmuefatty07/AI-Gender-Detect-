# ============================================
# Release Management Pipeline
# ============================================

name: Release

on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: python -m build

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*

    - name: Create GitHub release assets
      run: |
        # Create release archive
        tar -czf gender-age-classifier-${{ github.event.release.tag_name }}.tar.gz \
          --exclude='.git' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='datasets' \
          --exclude='models' \
          --exclude='logs' \
          .

    - name: Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./gender-age-classifier-${{ github.event.release.tag_name }}.tar.gz
        asset_name: gender-age-classifier-${{ github.event.release.tag_name }}.tar.gz
        asset_content_type: application/gzip

  deploy-docs:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install docs dependencies
      run: |
        pip install sphinx sphinx-rtd-theme myst-parser

    - name: Build documentation
      run: |
        cd docs
        make html

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: docs/_build/html

  update-docker-hub:
    runs-on: ubuntu-latest

    steps:
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/gender-age-classifier:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/gender-age-classifier:${{ github.event.release.tag_name }}

  create-changelog:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate changelog
      run: |
        # Install git-changelog
        pip install git-changelog

        # Generate changelog
        git-changelog -o CHANGELOG.md --release-notes .

    - name: Update release with changelog
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.release.tag_name }}
        body_path: CHANGELOG.md
        append_body: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: [release, deploy-docs, update-docker-hub, create-changelog]
    if: always()

    steps:
    - name: Notify stakeholders
      run: |
        echo "üéâ Release ${{ github.event.release.tag_name }} completed!"
        echo "üì¶ PyPI: Published"
        echo "üê≥ Docker Hub: Updated"
        echo "üìö Docs: Deployed to GitHub Pages"
        echo "üìù Changelog: Generated"

        # Here you could add Slack/Discord notifications
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"New release: ${{ github.event.release.tag_name }}"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}

